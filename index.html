<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Level Up - 7 Levels of Self</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d0a1a;--card:rgba(30,26,46,0.95);--border:#3d3655;--text:#f5f0ff;--muted:#b8b0cc;--pink:#FF3CAC;--orange:#FF6B35;--purple:#784BA0;--blue:#2F80ED;--green:#00D26A;--yellow:#F7C948;--silver:#C0C0C0;--red:#FF4757;--gold:#FFD700}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:linear-gradient(180deg,#1a1035 0%,#0d0a1a 100%);min-height:100vh;min-height:100dvh;color:var(--text);-webkit-font-smoothing:antialiased;letter-spacing:-0.01em;overflow-x:hidden}
.app{max-width:500px;margin:0 auto;padding:16px;padding-bottom:40px}
.hook{position:fixed;inset:0;background:linear-gradient(180deg,#1a1035 0%,#0d0a1a 100%);display:flex;align-items:center;justify-content:center;z-index:300;text-align:center;padding:24px}
.hook.hidden{display:none}
.hook-line{font-size:38px;font-weight:800;margin-bottom:16px;opacity:0;transform:translateY(20px);background:linear-gradient(135deg,var(--orange),var(--pink),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-0.02em}
.hook-line.show{animation:fadeUp 0.8s forwards}
.hook-sub{font-size:18px;color:var(--muted);line-height:1.6;margin:24px 0;opacity:0}
.hook-sub.show{animation:fadeUp 0.8s forwards}
.hook-btn{padding:18px 48px;background:linear-gradient(135deg,var(--orange),var(--pink));border:none;border-radius:16px;color:#fff;font-size:18px;font-weight:700;cursor:pointer;opacity:0;transform:translateY(20px)}
.hook-btn.show{animation:fadeUp 0.6s forwards}
@keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
.onboard{position:fixed;inset:0;background:linear-gradient(180deg,#1a1035 0%,#0d0a1a 100%);display:none;flex-direction:column;z-index:200;overflow:hidden}
.onboard.active{display:flex}
.onboard-screen{display:none;flex-direction:column;height:100%;padding:24px;padding-bottom:100px;overflow-y:auto}
.onboard-screen.active{display:flex}
.onboard-title{font-size:28px;font-weight:800;text-align:center;margin:32px 0 20px;background:linear-gradient(135deg,var(--orange),var(--pink),var(--purple),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-0.02em}
.onboard-sub{text-align:center;color:var(--muted);font-size:15px;font-weight:500;margin-bottom:20px;line-height:1.6}
.onboard-text{text-align:center;color:var(--muted);font-size:16px;font-weight:500;line-height:1.7;margin-bottom:8px}
.onboard-text2{text-align:center;color:var(--text);font-size:15px;font-weight:500;line-height:1.7;margin-bottom:8px}
.onboard-highlight{text-align:center;color:var(--text);font-size:17px;font-weight:600;line-height:1.7}
.onboard-highlight strong{color:var(--pink);font-weight:700}
.onboard-spacer{height:24px}
.onboard-levels{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
.onboard-level{display:flex;align-items:center;gap:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px}
.onboard-num{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:#000;flex-shrink:0}
.onboard-info{flex:1}
.onboard-name{font-size:15px;font-weight:600;letter-spacing:-0.01em}
.onboard-desc{font-size:13px;font-weight:500;color:var(--muted)}
.onboard-dots{display:flex;justify-content:center;gap:8px;margin:20px 0}
.dot{width:8px;height:8px;border-radius:50%;background:var(--border)}
.dot.active{background:var(--pink)}
.onboard-btns{display:flex;gap:12px;margin-top:auto;padding:20px 0}
.onboard-skip{flex:0;padding:16px 24px;background:transparent;border:none;color:var(--muted);font-size:15px;font-weight:500;cursor:pointer}
.onboard-next,.onboard-start{flex:1;padding:16px;background:linear-gradient(135deg,var(--orange),var(--pink));border:none;border-radius:12px;color:#fff;font-size:16px;font-weight:700;cursor:pointer;letter-spacing:-0.01em}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.logo{font-size:24px;font-weight:800;background:linear-gradient(135deg,var(--orange),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-0.02em}
.controls{display:flex;gap:8px}
.ctrl-btn{width:44px;height:44px;border-radius:50%;background:var(--card);border:1px solid var(--border);color:var(--muted);font-size:20px;cursor:pointer}
.ctrl-btn.on{background:linear-gradient(135deg,var(--orange),var(--pink));color:#fff;border:none}
.hero{text-align:center;margin-bottom:24px}
.hero h1{font-size:30px;font-weight:800;margin-bottom:10px;background:linear-gradient(135deg,var(--orange),var(--pink),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-0.02em}
.hero p{color:var(--muted);font-size:15px;font-weight:500}
.challenge{background:var(--card);border:2px solid var(--pink);border-radius:16px;padding:20px;margin-bottom:20px;cursor:pointer;transition:transform 0.2s}
.challenge:hover{transform:translateY(-3px)}
.badge{display:inline-flex;align-items:center;gap:6px;background:var(--pink);color:#fff;font-size:11px;font-weight:700;padding:6px 12px;border-radius:20px;margin-bottom:12px}
.badge-dot{width:8px;height:8px;background:#fff;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.challenge h2{font-size:22px;font-weight:700;margin-bottom:8px;letter-spacing:-0.01em}
.challenge p{color:var(--muted);font-size:14px;font-weight:500;margin-bottom:14px;line-height:1.5}
.challenge-footer{display:flex;justify-content:space-between;font-size:13px;color:var(--muted)}
.challenge.done{opacity:0.6}
.challenge.done .badge{background:var(--green)}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:24px}
.stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 8px;text-align:center}
.stat-val{font-size:26px;font-weight:700;background:linear-gradient(135deg,var(--orange),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-label{font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-top:6px}
.modes{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:28px}
.mode{background:var(--card);border:2px solid var(--border);border-radius:16px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
.mode:hover{transform:translateY(-3px);border-color:var(--pink)}
.mode-icon{font-size:36px;margin-bottom:10px}
.mode-name{font-size:16px;font-weight:700;margin-bottom:6px;letter-spacing:-0.01em}
.mode-desc{font-size:13px;font-weight:500;color:var(--muted)}
.section-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:14px}
.levels{display:flex;flex-direction:column;gap:8px;margin-bottom:28px}
.level{display:flex;align-items:center;gap:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;cursor:pointer;transition:all 0.2s}
.level:hover{border-color:var(--pink)}
.level.locked{opacity:0.4;cursor:not-allowed}
.level.locked:hover{border-color:var(--border)}
.level-num{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:#000;flex-shrink:0}
.level-info{flex:1}
.level-name{font-size:15px;font-weight:600;letter-spacing:-0.01em}
.level-desc{font-size:13px;font-weight:500;color:var(--muted)}
.footer{text-align:center;padding:20px}
.footer a{color:var(--pink);text-decoration:none;font-size:14px;font-weight:600}
.footer p{font-size:12px;color:var(--muted);margin-top:6px}
.game{display:none}
.game.active{display:block}
.home.hidden{display:none}
.game-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.game-info{font-size:15px}
.game-mode{color:var(--muted);font-size:12px;text-transform:uppercase}
.quit{width:44px;height:44px;border-radius:50%;background:rgba(255,71,87,0.2);border:2px solid var(--red);color:var(--red);font-size:20px;cursor:pointer}
.timer{height:8px;background:var(--border);border-radius:4px;margin-bottom:20px;overflow:hidden}
.timer.hidden{display:none}
.timer-fill{height:100%;background:var(--green);transition:width 0.1s}
.timer-fill.warn{background:var(--gold)}
.timer-fill.danger{background:var(--red)}
.scenario{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:16px}
.scenario-cat{display:inline-block;background:var(--border);padding:6px 12px;border-radius:20px;font-size:11px;text-transform:uppercase;margin-bottom:14px}
.scenario-text{font-size:17px;line-height:1.7}
.choices{display:flex;flex-direction:column;gap:10px}
.choice{width:100%;padding:16px 20px;background:var(--card);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:15px;text-align:left;cursor:pointer;line-height:1.5;transition:all 0.2s}
.choice:hover:not(:disabled){border-color:var(--pink)}
.choice:disabled{cursor:default}
.choice.selected{border-color:var(--pink);background:rgba(255,60,172,0.1)}
.choice.correct{border-color:var(--green);background:rgba(0,210,106,0.15)}
.choice.wrong{border-color:var(--red);background:rgba(255,71,87,0.15)}
.choice.dim{opacity:0.3}
.results{display:none;text-align:center;padding-top:40px}
.results.active{display:block}
.results h2{font-size:24px;margin-bottom:20px}
.score{font-size:72px;font-weight:900;background:linear-gradient(135deg,var(--orange),var(--pink),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:20px 0}
.result-msg{font-size:18px;color:var(--muted);margin-bottom:32px}
.results-btn{width:100%;padding:18px;background:linear-gradient(135deg,var(--orange),var(--pink));border:none;border-radius:12px;color:#fff;font-size:16px;font-weight:700;cursor:pointer}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;z-index:100}
.modal.active{display:flex}
.modal-content{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:28px;max-width:400px;width:100%}
.modal-icon{font-size:56px;text-align:center;margin-bottom:12px}
.modal-title{font-size:26px;font-weight:700;text-align:center;margin-bottom:20px}
.feedback-box{background:rgba(0,0,0,0.3);border-radius:12px;padding:18px;margin-bottom:20px}
.feedback-label{font-size:11px;color:var(--muted);text-transform:uppercase;margin-bottom:10px}
.feedback-text{font-size:15px;line-height:1.6}
.modal-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--orange),var(--pink));border:none;border-radius:12px;color:#fff;font-size:16px;font-weight:700;cursor:pointer}
@media(max-width:400px){.hook-line{font-size:32px}.hook-sub{font-size:16px}.hook-btn{padding:16px 40px;font-size:16px}.onboard-title{font-size:24px;margin-top:20px}.onboard-text{font-size:15px}.onboard-text2{font-size:14px}.onboard-highlight{font-size:15px}.onboard-level{padding:10px 12px}.onboard-num{width:34px;height:34px;font-size:14px}.onboard-name{font-size:14px}.onboard-desc{font-size:12px}.hero h1{font-size:26px}.hero p{font-size:14px}.challenge{padding:16px}.challenge h2{font-size:20px}.challenge p{font-size:13px}.badge{font-size:10px;padding:5px 10px}.stats{gap:8px}.stat{padding:12px 6px}.stat-val{font-size:22px}.stat-label{font-size:9px}.modes{gap:10px}.mode{padding:16px}.mode-icon{font-size:30px}.mode-name{font-size:15px}.mode-desc{font-size:11px}.level{padding:12px}.level-num{width:32px;height:32px;font-size:14px}.level-name{font-size:14px}.level-desc{font-size:11px}.scenario{padding:18px}.scenario-text{font-size:16px}.choice{padding:14px 16px;font-size:14px}.score{font-size:60px}}
@supports(padding:max(0px)){.app{padding-left:max(16px,env(safe-area-inset-left));padding-right:max(16px,env(safe-area-inset-right));padding-bottom:max(40px,env(safe-area-inset-bottom))}.onboard-screen{padding-left:max(24px,env(safe-area-inset-left));padding-right:max(24px,env(safe-area-inset-right));padding-bottom:max(100px,env(safe-area-inset-bottom))}.onboard-btns{padding-bottom:max(20px,env(safe-area-inset-bottom))}.hook{padding-left:max(24px,env(safe-area-inset-left));padding-right:max(24px,env(safe-area-inset-right))}}
input,select,textarea{font-size:16px}
.onboard-screen,.app{-webkit-overflow-scrolling:touch}
.mode:active,.challenge:active,.choice:active,.onboard-next:active,.onboard-start:active,.hook-btn:active,.modal-btn:active,.results-btn:active{transform:scale(0.98);opacity:0.9}
button{-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}
</style>
</head>
<body>
<audio id="music" loop><source src="level-up.mp3" type="audio/mpeg"></audio>

<div class="hook" id="hook">
<div>
<div class="hook-line" id="line1">Something's off.</div>
<div class="hook-line" id="line2">You can feel it.</div>
<div class="hook-sub" id="hookSub">This game shows you exactly where<br>‚Äî and what to do about it.</div>
<button class="hook-btn" id="hookBtn">Show Me</button>
</div>
</div>

<div class="onboard" id="onboard">
<div class="onboard-screen active" id="onboard1">
<div class="onboard-title">There Are Levels To This</div>
<div class="onboard-text">Most people are stuck ‚Äî not because they lack knowledge, but because they're working on the wrong level.</div>
<div class="onboard-text">You can't build a roof before the foundation.</div>
<div class="onboard-spacer"></div>
<div class="onboard-text2">Two games. One transformation.</div>
<div class="onboard-text2">Mirror Game reveals who you are. Decision Game trains who you become.</div>
<div class="onboard-spacer"></div>
<div class="onboard-highlight">The goal isn't the "highest" level.<br>It's the <strong>right</strong> level.</div>
<div class="onboard-dots"><span class="dot active"></span><span class="dot"></span></div>
<div class="onboard-btns">
<button class="onboard-skip" id="skipBtn">Skip</button>
<button class="onboard-next" id="nextBtn1">Next</button>
</div>
</div>
<div class="onboard-screen" id="onboard2">
<div class="onboard-title">The 7 Levels of Self</div>
<div class="onboard-sub">You can't skip levels. Master each one before you climb.</div>
<div class="onboard-levels">
<div class="onboard-level"><div class="onboard-num" style="background:#FF6B35">1</div><div class="onboard-info"><div class="onboard-name">Individual</div><div class="onboard-desc">Your relationship with yourself</div></div></div>
<div class="onboard-level"><div class="onboard-num" style="background:#FF3CAC">2</div><div class="onboard-info"><div class="onboard-name">Family</div><div class="onboard-desc">Your closest relationships</div></div></div>
<div class="onboard-level"><div class="onboard-num" style="background:#784BA0">3</div><div class="onboard-info"><div class="onboard-name">Groups</div><div class="onboard-desc">Teams, friends, communities</div></div></div>
<div class="onboard-level"><div class="onboard-num" style="background:#2F80ED">4</div><div class="onboard-info"><div class="onboard-name">Community</div><div class="onboard-desc">Your role in the larger whole</div></div></div>
<div class="onboard-level"><div class="onboard-num" style="background:#00D26A">5</div><div class="onboard-info"><div class="onboard-name">Society</div><div class="onboard-desc">Systems, culture, nation</div></div></div>
<div class="onboard-level"><div class="onboard-num" style="background:#F7C948">6</div><div class="onboard-info"><div class="onboard-name">World</div><div class="onboard-desc">Global connection</div></div></div>
<div class="onboard-level"><div class="onboard-num" style="background:#C0C0C0">7</div><div class="onboard-info"><div class="onboard-name">Generations</div><div class="onboard-desc">Legacy that outlasts you</div></div></div>
</div>
<div class="onboard-dots"><span class="dot"></span><span class="dot active"></span></div>
<div class="onboard-btns">
<button class="onboard-skip" id="skipBtn2">Skip</button>
<button class="onboard-start" id="goBtn">Let's Go</button>
</div>
</div>
</div>

<div class="app">
<div class="home" id="home">
<div class="header">
<div class="logo">LEVEL UP</div>
<div class="controls">
<button class="ctrl-btn" id="musicBtn">üéµ</button>
<button class="ctrl-btn on" id="soundBtn">üîä</button>
</div>
</div>
<div class="hero">
<h1>Discover Your Level</h1>
<p>Mirror reveals. Decision trains. Levels integrate.</p>
</div>
<div class="challenge" id="dailyCard">
<div class="badge"><span class="badge-dot"></span>DAILY CHALLENGE</div>
<h2>7-Level Journey</h2>
<p>One scenario from each level. Same for everyone worldwide.</p>
<div class="challenge-footer">
<span id="dailyCta">Tap to begin today's challenge</span>
<span id="dailyTimer">Resets in --:--:--</span>
</div>
</div>
<div class="stats">
<div class="stat"><div class="stat-val" id="statPlayed">0</div><div class="stat-label">Played</div></div>
<div class="stat"><div class="stat-val" id="statMirror">0</div><div class="stat-label">Recognized</div></div>
<div class="stat"><div class="stat-val" id="statAccept">0</div><div class="stat-label">Accepted</div></div>
<div class="stat"><div class="stat-val" id="statStreak">0</div><div class="stat-label">Streak</div></div>
</div>
<div class="modes">
<div class="mode" id="mirrorMode"><div class="mode-icon">ü™û</div><div class="mode-name">Mirror Game</div><div class="mode-desc">See yourself honestly</div></div>
<div class="mode" id="decisionMode"><div class="mode-icon">‚öñÔ∏è</div><div class="mode-name">Decision Game</div><div class="mode-desc">Acceptance vs Judgment</div></div>
</div>
<div class="section-title">Your Journey</div>
<div class="levels" id="levelMap"></div>
<div class="footer">
<a href="https://levelsofself.com" target="_blank">Learn the Full Framework ‚Üí</a>
<p>LevelsOfSelf.com</p>
</div>
</div>

<div class="game" id="game">
<div class="game-header">
<div class="game-info"><div class="game-mode" id="gameMode">Mirror</div><div id="gameProgress">1/5</div></div>
<button class="quit" id="quitBtn">‚úï</button>
</div>
<div class="timer" id="timerBar"><div class="timer-fill" id="timerFill"></div></div>
<div class="scenario">
<div class="scenario-cat" id="scenarioCat">Level 1: Individual</div>
<div class="scenario-text" id="scenarioText">Loading...</div>
</div>
<div class="choices" id="choices"></div>
</div>

<div class="results" id="results">
<h2 id="resultsTitle">Game Complete</h2>
<div class="score" id="finalScore">0</div>
<p class="result-msg" id="resultMsg">Keep going!</p>
<button class="results-btn" id="homeBtn">Continue</button>
</div>
</div>

<div class="modal" id="feedbackModal">
<div class="modal-content">
<div class="modal-icon" id="fbIcon">üí°</div>
<div class="modal-title" id="fbTitle">Insight</div>
<div class="feedback-box">
<div class="feedback-label" id="fbLabel">Reflection</div>
<div class="feedback-text" id="fbText">...</div>
</div>
<button class="modal-btn" id="nextBtn">Next</button>
</div>
</div>

<!-- LOAD EXTERNAL SCENARIO FILES -->
<script src="mirror-level1-individual.js"></script>
<script src="mirror-level2-family.js"></script>
<script src="mirror-level3-groups.js"></script>
<script src="mirror-level4-community.js"></script>
<script src="mirror-level5-society.js"></script>
<script src="mirror-level6-world.js"></script>
<script src="mirror-level7-generations.js"></script>
<script src="decision-scenarios.js"></script>

<script>
// ========== COMBINE MIRROR SCENARIOS ==========
const MIRROR_SCENARIOS = [
  ...(typeof LEVEL_1_INDIVIDUAL !== 'undefined' ? LEVEL_1_INDIVIDUAL : []),
  ...(typeof LEVEL_2_FAMILY !== 'undefined' ? LEVEL_2_FAMILY : []),
  ...(typeof LEVEL_3_GROUPS !== 'undefined' ? LEVEL_3_GROUPS : []),
  ...(typeof LEVEL_4_COMMUNITY !== 'undefined' ? LEVEL_4_COMMUNITY : []),
  ...(typeof LEVEL_5_SOCIETY !== 'undefined' ? LEVEL_5_SOCIETY : []),
  ...(typeof LEVEL_6_WORLD !== 'undefined' ? LEVEL_6_WORLD : []),
  ...(typeof LEVEL_7_GENERATIONS !== 'undefined' ? LEVEL_7_GENERATIONS : [])
];

// ========== LEVEL METADATA ==========
const LEVELS = [
  {id:1, name:'Individual', color:'#FF6B35', desc:'Your relationship with yourself'},
  {id:2, name:'Family', color:'#FF3CAC', desc:'Your closest relationships'},
  {id:3, name:'Groups', color:'#784BA0', desc:'Teams, friends, communities'},
  {id:4, name:'Community', color:'#2F80ED', desc:'Your role in the larger whole'},
  {id:5, name:'Society', color:'#00D26A', desc:'Systems, culture, nation'},
  {id:6, name:'World', color:'#F7C948', desc:'Global connection'},
  {id:7, name:'Generations', color:'#C0C0C0', desc:'Legacy that outlasts you'}
];

// ========== GAME STATE ==========
let music = document.getElementById('music');
music.volume = 0.4;
let musicOn = false;
let soundOn = true;

let data = JSON.parse(localStorage.getItem('levelup_v2')) || {
  games: 0, mirrorRecognized: 0, mirrorTotal: 0, decisionAccepted: 0, decisionTotal: 0,
  streak: 0, lastDaily: null, unlocked: [1,2,3,4,5,6,7], seenIntro: false
};

let game = { mode: null, scenarios: [], idx: 0, answers: [], timer: null, timeLeft: 15, useTimer: true };

function save() { localStorage.setItem('levelup_v2', JSON.stringify(data)); }

// ========== AUDIO ==========
function playSound(freq, dur) {
  if (!soundOn) return;
  try {
    let ctx = new (window.AudioContext || window.webkitAudioContext)();
    let osc = ctx.createOscillator();
    let gain = ctx.createGain();
    osc.frequency.value = freq;
    osc.connect(gain);
    gain.connect(ctx.destination);
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
    osc.start();
    osc.stop(ctx.currentTime + dur);
  } catch (e) {}
}
function positiveSound() { [523, 659, 784].forEach((f, i) => setTimeout(() => playSound(f, 0.15), i * 80)); }
function neutralSound() { playSound(440, 0.2); }

// ========== UTILITIES ==========
function shuffle(arr) {
  let a = [...arr];
  for (let i = a.length - 1; i > 0; i--) { let j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; }
  return a;
}
function hashDate(dateStr) {
  let hash = 0;
  for (let i = 0; i < dateStr.length; i++) { hash = ((hash << 5) - hash) + dateStr.charCodeAt(i); hash = hash & hash; }
  return Math.abs(hash);
}

// ========== HOOK & ONBOARDING ==========
function showHook() {
  setTimeout(() => document.getElementById('line1').classList.add('show'), 400);
  setTimeout(() => document.getElementById('line2').classList.add('show'), 1400);
  setTimeout(() => document.getElementById('hookSub').classList.add('show'), 2600);
  setTimeout(() => document.getElementById('hookBtn').classList.add('show'), 3400);
}

document.getElementById('hookBtn').onclick = function() {
  document.getElementById('hook').classList.add('hidden');
  document.getElementById('onboard').classList.add('active');
  music.play().then(() => { musicOn = true; document.getElementById('musicBtn').classList.add('on'); }).catch(e => {});
};

document.getElementById('skipBtn').onclick = document.getElementById('skipBtn2').onclick = function() {
  data.seenIntro = true; save();
  document.getElementById('onboard').classList.remove('active');
  updateHome();
};

document.getElementById('nextBtn1').onclick = function() {
  document.getElementById('onboard1').classList.remove('active');
  document.getElementById('onboard2').classList.add('active');
};

document.getElementById('goBtn').onclick = function() {
  data.seenIntro = true; save();
  document.getElementById('onboard').classList.remove('active');
  updateHome();
};

// ========== HOME SCREEN ==========
function updateHome() {
  document.getElementById('statPlayed').textContent = data.games;
  document.getElementById('statMirror').textContent = data.mirrorRecognized;
  document.getElementById('statAccept').textContent = data.decisionAccepted;
  document.getElementById('statStreak').textContent = data.streak;
  
  let today = new Date().toDateString();
  let daily = document.getElementById('dailyCard');
  if (data.lastDaily === today) {
    daily.classList.add('done');
    document.getElementById('dailyCta').textContent = "‚úì Completed today";
  } else {
    daily.classList.remove('done');
    document.getElementById('dailyCta').textContent = 'Tap to begin today\'s challenge';
  }
  
  let map = document.getElementById('levelMap');
  map.innerHTML = '';
  LEVELS.forEach((lv) => {
    let unlocked = data.unlocked.includes(lv.id);
    let div = document.createElement('div');
    div.className = 'level' + (unlocked ? '' : ' locked');
    div.innerHTML = '<div class="level-num" style="background:' + lv.color + '">' + lv.id + '</div><div class="level-info"><div class="level-name">' + lv.name + (unlocked ? '' : ' üîí') + '</div><div class="level-desc">' + lv.desc + '</div></div>';
    if (unlocked) div.onclick = () => startLevelPlay(lv.id);
    map.appendChild(div);
  });
  updateTimer();
}

function updateTimer() {
  let now = new Date();
  let tom = new Date(now); tom.setDate(tom.getDate() + 1); tom.setHours(0, 0, 0, 0);
  let d = tom - now;
  let h = String(Math.floor(d / 3600000)).padStart(2, '0');
  let m = String(Math.floor((d % 3600000) / 60000)).padStart(2, '0');
  let s = String(Math.floor((d % 60000) / 1000)).padStart(2, '0');
  document.getElementById('dailyTimer').textContent = 'Resets in ' + h + ':' + m + ':' + s;
}

// ========== START GAMES ==========
function startMirrorGame(levelFilter = null) {
  game.mode = 'mirror'; game.idx = 0; game.answers = []; game.useTimer = false;
  let pool = MIRROR_SCENARIOS.filter(s => levelFilter ? s.level === levelFilter : data.unlocked.includes(s.level));
  if (pool.length === 0) { alert('No Mirror scenarios available.'); return; }
  game.scenarios = shuffle(pool).slice(0, 10);
  document.getElementById('home').classList.add('hidden');
  document.getElementById('results').classList.remove('active');
  document.getElementById('game').classList.add('active');
  document.getElementById('gameMode').textContent = 'Mirror Game';
  document.getElementById('timerBar').classList.add('hidden');
  showMirrorScenario();
}

function startDecisionGame(levelFilter = null) {
  game.mode = 'decision'; game.idx = 0; game.answers = []; game.useTimer = true;
  if (typeof DECISION_SCENARIOS === 'undefined' || DECISION_SCENARIOS.length === 0) {
    alert('No Decision scenarios available. Check that decision-scenarios.js is loaded.'); return;
  }
  let pool = DECISION_SCENARIOS.filter(s => levelFilter ? s.level === levelFilter : data.unlocked.includes(s.level));
  if (pool.length === 0) { alert('No Decision scenarios available.'); return; }
  game.scenarios = shuffle(pool).slice(0, 10);
  document.getElementById('home').classList.add('hidden');
  document.getElementById('results').classList.remove('active');
  document.getElementById('game').classList.add('active');
  document.getElementById('gameMode').textContent = 'Decision Game';
  document.getElementById('timerBar').classList.remove('hidden');
  showDecisionScenario();
}

function startDailyChallenge() {
  let today = new Date().toDateString();
  if (data.lastDaily === today) return;
  game.mode = 'daily'; game.idx = 0; game.answers = []; game.useTimer = true; game.scenarios = [];
  let seed = hashDate(today);
  for (let lvl = 1; lvl <= 7; lvl++) {
    if (lvl % 2 === 1) {
      let pool = MIRROR_SCENARIOS.filter(s => s.level === lvl);
      if (pool.length > 0) { game.scenarios.push({...pool[seed % pool.length], gameType: 'mirror'}); }
    } else {
      if (typeof DECISION_SCENARIOS !== 'undefined') {
        let pool = DECISION_SCENARIOS.filter(s => s.level === lvl);
        if (pool.length > 0) { game.scenarios.push({...pool[seed % pool.length], gameType: 'decision'}); }
      }
    }
    seed = (seed * 31337) & 0xFFFFFF;
  }
  if (game.scenarios.length === 0) { alert('No scenarios available.'); return; }
  document.getElementById('home').classList.add('hidden');
  document.getElementById('results').classList.remove('active');
  document.getElementById('game').classList.add('active');
  document.getElementById('gameMode').textContent = 'Daily Challenge';
  showDailyScenario();
}

function startLevelPlay(levelId) { startMirrorGame(levelId); }

// ========== MIRROR GAME LOGIC ==========
function showMirrorScenario() {
  let s = game.scenarios[game.idx];
  if (!s) { endGame(); return; }
  document.getElementById('gameProgress').textContent = (game.idx + 1) + '/' + game.scenarios.length;
  let levelInfo = LEVELS.find(l => l.id === s.level);
  document.getElementById('scenarioCat').textContent = 'Level ' + s.level + ': ' + (levelInfo ? levelInfo.name : '');
  document.getElementById('scenarioText').textContent = s.text;
  let container = document.getElementById('choices');
  container.innerHTML = '';
  [{ text: "That's Me", value: true }, { text: "That's Not Me", value: false }].forEach(c => {
    let btn = document.createElement('button');
    btn.className = 'choice';
    btn.textContent = c.text;
    btn.onclick = () => selectMirrorChoice(c, btn, s);
    container.appendChild(btn);
  });
}

function selectMirrorChoice(choice, btn, scenario) {
  document.querySelectorAll('.choice').forEach(b => b.disabled = true);
  btn.classList.add('selected');
  game.answers.push({ recognized: choice.value, insight: scenario.insight });
  if (choice.value) data.mirrorRecognized++;
  data.mirrorTotal++;
  positiveSound();
  setTimeout(() => showMirrorFeedback(scenario.insight, choice.value), 400);
}

function showMirrorFeedback(insight, recognized) {
  document.getElementById('fbIcon').textContent = 'üí°';
  document.getElementById('fbIcon').style.color = 'var(--pink)';
  document.getElementById('fbTitle').textContent = recognized ? 'Recognized' : 'Noted';
  document.getElementById('fbLabel').textContent = 'Insight';
  document.getElementById('fbText').textContent = insight;
  document.getElementById('feedbackModal').classList.add('active');
}

// ========== DECISION GAME LOGIC ==========
function showDecisionScenario() {
  let s = game.scenarios[game.idx];
  if (!s) { endGame(); return; }
  document.getElementById('gameProgress').textContent = (game.idx + 1) + '/' + game.scenarios.length;
  let levelInfo = LEVELS.find(l => l.id === s.level);
  document.getElementById('scenarioCat').textContent = 'Level ' + s.level + ': ' + (levelInfo ? levelInfo.name : '');
  document.getElementById('scenarioText').textContent = s.scenario;
  let container = document.getElementById('choices');
  container.innerHTML = '';
  shuffle(s.choices).forEach(c => {
    let btn = document.createElement('button');
    btn.className = 'choice';
    btn.textContent = c.text;
    btn.onclick = () => selectDecisionChoice(c, btn, s);
    container.appendChild(btn);
  });
  if (game.useTimer) startTimer();
}

function selectDecisionChoice(choice, btn, scenario) {
  if (game.timer) clearInterval(game.timer);
  document.querySelectorAll('.choice').forEach(b => b.disabled = true);
  let isAcceptance = choice.type === 'acceptance';
  game.answers.push({ type: choice.type, isAcceptance: isAcceptance, insight: choice.insight });
  if (isAcceptance) {
    btn.classList.add('correct');
    data.decisionAccepted++;
    positiveSound();
  } else {
    btn.classList.add('wrong');
    let acceptanceChoice = scenario.choices.find(c => c.type === 'acceptance');
    document.querySelectorAll('.choice').forEach(b => {
      if (b.textContent === acceptanceChoice.text) b.classList.add('correct');
      else if (b !== btn) b.classList.add('dim');
    });
    neutralSound();
  }
  data.decisionTotal++;
  setTimeout(() => showDecisionFeedback(choice, isAcceptance), 500);
}

function showDecisionFeedback(choice, isAcceptance) {
  document.getElementById('fbIcon').textContent = isAcceptance ? '‚úì' : '‚öñÔ∏è';
  document.getElementById('fbIcon').style.color = isAcceptance ? 'var(--green)' : 'var(--yellow)';
  document.getElementById('fbTitle').textContent = isAcceptance ? 'Acceptance' : 'Judgment';
  document.getElementById('fbLabel').textContent = isAcceptance ? 'Why this works' : 'Learning opportunity';
  document.getElementById('fbText').textContent = choice.insight;
  document.getElementById('feedbackModal').classList.add('active');
}

// ========== DAILY CHALLENGE LOGIC ==========
function showDailyScenario() {
  let s = game.scenarios[game.idx];
  if (!s) { endGame(); return; }
  document.getElementById('gameProgress').textContent = (game.idx + 1) + '/7';
  let levelInfo = LEVELS.find(l => l.id === s.level);
  if (s.gameType === 'mirror') {
    document.getElementById('timerBar').classList.add('hidden');
    document.getElementById('scenarioCat').textContent = 'ü™û Level ' + s.level + ': ' + (levelInfo ? levelInfo.name : '');
    document.getElementById('scenarioText').textContent = s.text;
    let container = document.getElementById('choices');
    container.innerHTML = '';
    [{ text: "That's Me", value: true }, { text: "That's Not Me", value: false }].forEach(c => {
      let btn = document.createElement('button');
      btn.className = 'choice';
      btn.textContent = c.text;
      btn.onclick = () => {
        document.querySelectorAll('.choice').forEach(b => b.disabled = true);
        btn.classList.add('selected');
        game.answers.push({ type: 'mirror', recognized: c.value });
        if (c.value) data.mirrorRecognized++;
        data.mirrorTotal++;
        positiveSound();
        setTimeout(() => showMirrorFeedback(s.insight, c.value), 400);
      };
      container.appendChild(btn);
    });
  } else {
    document.getElementById('timerBar').classList.remove('hidden');
    document.getElementById('scenarioCat').textContent = '‚öñÔ∏è Level ' + s.level + ': ' + (levelInfo ? levelInfo.name : '');
    document.getElementById('scenarioText').textContent = s.scenario;
    let container = document.getElementById('choices');
    container.innerHTML = '';
    shuffle(s.choices).forEach(c => {
      let btn = document.createElement('button');
      btn.className = 'choice';
      btn.textContent = c.text;
      btn.onclick = () => {
        if (game.timer) clearInterval(game.timer);
        document.querySelectorAll('.choice').forEach(b => b.disabled = true);
        let isAcceptance = c.type === 'acceptance';
        game.answers.push({ type: 'decision', isAcceptance: isAcceptance });
        if (isAcceptance) { btn.classList.add('correct'); data.decisionAccepted++; positiveSound(); }
        else {
          btn.classList.add('wrong');
          let acceptanceChoice = s.choices.find(ch => ch.type === 'acceptance');
          document.querySelectorAll('.choice').forEach(b => {
            if (b.textContent === acceptanceChoice.text) b.classList.add('correct');
            else if (b !== btn) b.classList.add('dim');
          });
          neutralSound();
        }
        data.decisionTotal++;
        setTimeout(() => showDecisionFeedback(c, isAcceptance), 500);
      };
      container.appendChild(btn);
    });
    startTimer();
  }
}

// ========== TIMER ==========
function startTimer() {
  game.timeLeft = 15;
  if (game.timer) clearInterval(game.timer);
  game.timer = setInterval(() => {
    game.timeLeft -= 0.1;
    let pct = (game.timeLeft / 15) * 100;
    let fill = document.getElementById('timerFill');
    fill.style.width = pct + '%';
    fill.classList.remove('warn', 'danger');
    if (game.timeLeft <= 5) fill.classList.add('danger');
    else if (game.timeLeft <= 10) fill.classList.add('warn');
    if (game.timeLeft <= 0) { clearInterval(game.timer); timeUp(); }
  }, 100);
}

function timeUp() {
  let s = game.scenarios[game.idx];
  document.querySelectorAll('.choice').forEach(b => b.disabled = true);
  let acceptanceChoice = s.choices.find(c => c.type === 'acceptance');
  game.answers.push({ type: 'decision', isAcceptance: false, timedOut: true });
  data.decisionTotal++;
  document.querySelectorAll('.choice').forEach(b => {
    if (b.textContent === acceptanceChoice.text) b.classList.add('correct');
    else b.classList.add('dim');
  });
  neutralSound();
  setTimeout(() => {
    document.getElementById('fbIcon').textContent = '‚è∞';
    document.getElementById('fbIcon').style.color = 'var(--yellow)';
    document.getElementById('fbTitle').textContent = 'Time\'s Up';
    document.getElementById('fbLabel').textContent = 'The accepting response';
    document.getElementById('fbText').textContent = acceptanceChoice.insight;
    document.getElementById('feedbackModal').classList.add('active');
  }, 500);
}

// ========== GAME FLOW ==========
document.getElementById('nextBtn').onclick = function() {
  document.getElementById('feedbackModal').classList.remove('active');
  game.idx++;
  if (game.idx >= game.scenarios.length) { endGame(); }
  else {
    if (game.mode === 'mirror') showMirrorScenario();
    else if (game.mode === 'decision') showDecisionScenario();
    else if (game.mode === 'daily') showDailyScenario();
  }
};

function endGame() {
  if (game.timer) clearInterval(game.timer);
  data.games++;
  if (game.mode === 'daily') {
    let today = new Date().toDateString();
    let yesterday = new Date(Date.now() - 86400000).toDateString();
    if (data.lastDaily === yesterday) data.streak++;
    else if (data.lastDaily !== today) data.streak = 1;
    data.lastDaily = today;
  }
  save();
  document.getElementById('game').classList.remove('active');
  document.getElementById('results').classList.add('active');
  if (game.mode === 'mirror') {
    let recognized = game.answers.filter(a => a.recognized).length;
    document.getElementById('resultsTitle').textContent = 'Mirror Complete';
    document.getElementById('finalScore').textContent = recognized + '/' + game.answers.length;
    document.getElementById('resultMsg').textContent = 'Patterns recognized. Awareness is the first step.';
  } else if (game.mode === 'decision') {
    let accepted = game.answers.filter(a => a.isAcceptance).length;
    document.getElementById('resultsTitle').textContent = 'Decision Complete';
    document.getElementById('finalScore').textContent = accepted + '/' + game.answers.length;
    document.getElementById('resultMsg').textContent = accepted >= 8 ? 'Strong acceptance practice!' : accepted >= 5 ? 'Growing in acceptance.' : 'Judgment is a habit. Acceptance is a skill.';
  } else if (game.mode === 'daily') {
    document.getElementById('resultsTitle').textContent = 'Daily Complete';
    document.getElementById('finalScore').textContent = 'üî• ' + data.streak;
    document.getElementById('resultMsg').textContent = 'Day streak! Come back tomorrow.';
  }
}

document.getElementById('homeBtn').onclick = function() {
  document.getElementById('results').classList.remove('active');
  document.getElementById('home').classList.remove('hidden');
  updateHome();
};

document.getElementById('quitBtn').onclick = function() {
  if (game.timer) clearInterval(game.timer);
  document.getElementById('game').classList.remove('active');
  document.getElementById('feedbackModal').classList.remove('active');
  document.getElementById('home').classList.remove('hidden');
  updateHome();
};

// ========== CONTROLS ==========
document.getElementById('musicBtn').onclick = function() {
  if (musicOn) { music.pause(); musicOn = false; this.classList.remove('on'); }
  else { music.play().then(() => { musicOn = true; this.classList.add('on'); }).catch(e => {}); }
};

document.getElementById('soundBtn').onclick = function() {
  soundOn = !soundOn;
  this.classList.toggle('on', soundOn);
  if (soundOn) playSound(600, 0.1);
};

document.getElementById('dailyCard').onclick = function() { if (!this.classList.contains('done')) startDailyChallenge(); };
document.getElementById('mirrorMode').onclick = () => startMirrorGame();
document.getElementById('decisionMode').onclick = () => startDecisionGame();

// ========== INITIALIZE ==========
if (data.seenIntro) { document.getElementById('hook').classList.add('hidden'); updateHome(); }
else { showHook(); }
setInterval(updateTimer, 1000);

console.log('Mirror scenarios loaded:', MIRROR_SCENARIOS.length);
console.log('Decision scenarios loaded:', typeof DECISION_SCENARIOS !== 'undefined' ? DECISION_SCENARIOS.length : 0);
</script>
</body>
</html>
